#cloud-config

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - git
  - curl
  - wget
  - fail2ban
  - ufw
  - unattended-upgrades
  - apt-listchanges
  - nginx
  - certbot
  - python3-certbot-nginx

write_files:
  - path: /opt/telegram-bot/.env
    permissions: "0600"
    content: |
      # Core Configuration
      TELEGRAM_TOKEN=${telegram_token}
      ENCRYPTION_KEY=${encryption_key}

      # Monero Wallet RPC Configuration
      MONERO_RPC_URL=http://monero-wallet:18083
      MONERO_WALLET_PASSWORD=${monero_wallet_password}
      MONERO_RPC_USER=${monero_rpc_user}
      MONERO_RPC_PASSWORD=${monero_rpc_password}

      # Admin Configuration
      ADMIN_IDS=${admin_ids}
      SUPER_ADMIN_IDS=${super_admin_ids}
      TOTP_SECRET=${totp_secret}

      # Data Management
      DATA_RETENTION_DAYS=30
      DEFAULT_COMMISSION_RATE=0.05

      # Logging Configuration
      LOG_LEVEL=INFO
      LOG_FILE=/app/logs/bot.log

      # Production Settings
      ENVIRONMENT=${environment}
      DATABASE_URL=mysql+pymysql://${mysql_user}:${mysql_password}@mysql:3306/${mysql_database}
      MAX_RETRIES=3
      RETRY_DELAY=5

      # MySQL Configuration
      MYSQL_ROOT_PASSWORD=${mysql_root_password}
      MYSQL_DATABASE=${mysql_database}
      MYSQL_USER=${mysql_user}
      MYSQL_PASSWORD=${mysql_password}

      # Health Check Configuration
      HEALTH_CHECK_ENABLED=true
      HEALTH_CHECK_PORT=8080

  - path: /etc/systemd/system/telegram-bot.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Telegram Bot Docker Compose
      After=docker.service
      Requires=docker.service

      [Service]
      Type=simple
      WorkingDirectory=/opt/telegram-bot
      ExecStart=/usr/bin/docker compose up
      ExecStop=/usr/bin/docker compose down
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

  # SSH hardening
  - path: /etc/ssh/sshd_config.d/hardening.conf
    permissions: "0644"
    content: |
      PermitRootLogin prohibit-password
      PasswordAuthentication no
      PubkeyAuthentication yes
      PermitEmptyPasswords no
      X11Forwarding no
      MaxAuthTries 3
      ClientAliveInterval 300
      ClientAliveCountMax 2

  # Fail2ban config
  - path: /etc/fail2ban/jail.local
    permissions: "0644"
    content: |
      [DEFAULT]
      bantime = 1h
      findtime = 10m
      maxretry = 3

      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 24h

  # Auto security updates
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    permissions: "0644"
    content: |
      Unattended-Upgrade::Allowed-Origins {
        "Ubuntu:noble";
        "Ubuntu:noble-security";
        "UbuntuESMApps:noble-apps-security";
        "UbuntuESM:noble-infra-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";

  # Nginx reverse proxy config
  - path: /etc/nginx/sites-available/api
    permissions: "0644"
    content: |
      server {
          listen 80;
          server_name ${domain};

          location / {
              proxy_pass http://127.0.0.1:8080;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
      }

  # Kernel hardening
  - path: /etc/sysctl.d/99-security.conf
    permissions: "0644"
    content: |
      # IP Spoofing protection
      net.ipv4.conf.all.rp_filter = 1
      net.ipv4.conf.default.rp_filter = 1
      # Ignore ICMP redirects
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv6.conf.all.accept_redirects = 0
      # Disable source routing
      net.ipv4.conf.all.accept_source_route = 0
      net.ipv6.conf.all.accept_source_route = 0
      # Ignore send redirects
      net.ipv4.conf.all.send_redirects = 0
      # Block SYN attacks
      net.ipv4.tcp_syncookies = 1
      net.ipv4.tcp_max_syn_backlog = 2048
      net.ipv4.tcp_synack_retries = 2
      # Log Martians
      net.ipv4.conf.all.log_martians = 1
      # Ignore ICMP ping
      net.ipv4.icmp_echo_ignore_broadcasts = 1
      # Disable IPv6 if not needed
      net.ipv6.conf.all.disable_ipv6 = 1
      net.ipv6.conf.default.disable_ipv6 = 1

runcmd:
  # Security hardening
  - sysctl -p /etc/sysctl.d/99-security.conf
  - systemctl enable fail2ban
  - systemctl start fail2ban
  - systemctl restart sshd
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades

  # UFW firewall setup
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp comment 'SSH'
  - ufw allow 80/tcp comment 'HTTP'
  - ufw allow 443/tcp comment 'HTTPS'
  - ufw allow 8080/tcp comment 'Health check'
  - ufw --force enable

  # Docker setup
  - systemctl enable docker
  - systemctl start docker

  # Install docker compose v2
  - mkdir -p /root/.docker/cli-plugins
  - curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /root/.docker/cli-plugins/docker-compose
  - chmod +x /root/.docker/cli-plugins/docker-compose

  # Bot setup - create directories
  - mkdir -p /opt/telegram-bot/data /opt/telegram-bot/logs /opt/telegram-bot/monero-wallet
  - chmod 777 /opt/telegram-bot/data /opt/telegram-bot/logs
  - chmod 700 /opt/telegram-bot /opt/telegram-bot/monero-wallet

  # Clone repository and setup
  - git clone https://github.com/${github_repo}.git /tmp/telegram-bot-repo
  - cp /tmp/telegram-bot-repo/docker-compose.yml /opt/telegram-bot/
  - rm -rf /tmp/telegram-bot-repo

  # Start services
  - systemctl daemon-reload
  - systemctl enable telegram-bot
  - systemctl start telegram-bot

  # Nginx setup
  - ln -sf /etc/nginx/sites-available/api /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - systemctl enable nginx
  - systemctl start nginx

  # Cleanup
  - apt-get clean
  - rm -rf /var/lib/apt/lists/*
