#cloud-config

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - git
  - curl
  - wget
  - bzip2
  - fail2ban
  - ufw
  - unattended-upgrades
  - apt-listchanges
  - nginx
  - certbot
  - python3-certbot-nginx

write_files:
  - path: /opt/telegram-bot/.env
    permissions: "0600"
    content: |
      TELEGRAM_TOKEN=${telegram_token}
      ENCRYPTION_KEY=${encryption_key}
      MONERO_RPC_URL=http://localhost:18082
      ADMIN_IDS=${admin_ids}
      ENVIRONMENT=${environment}
      DATA_RETENTION_DAYS=30
      LOG_LEVEL=INFO
      HEALTH_CHECK_ENABLED=true
      HEALTH_CHECK_PORT=8080

  - path: /etc/systemd/system/telegram-bot.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Telegram Bot
      After=docker.service monero-wallet-rpc.service
      Requires=docker.service
      Wants=monero-wallet-rpc.service

      [Service]
      Type=simple
      WorkingDirectory=/opt/telegram-bot
      ExecStart=/usr/bin/docker compose up
      ExecStop=/usr/bin/docker compose down
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/monero-wallet-rpc.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Monero Wallet RPC
      After=network.target

      [Service]
      Type=simple
      User=monero
      ExecStart=/opt/monero/monero-wallet-rpc \
        --daemon-address node.moneroworld.com:18089 \
        --rpc-bind-ip 127.0.0.1 \
        --rpc-bind-port 18082 \
        --disable-rpc-login \
        --wallet-dir /opt/monero/wallets \
        --confirm-external-bind
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

  # SSH hardening
  - path: /etc/ssh/sshd_config.d/hardening.conf
    permissions: "0644"
    content: |
      PermitRootLogin prohibit-password
      PasswordAuthentication no
      PubkeyAuthentication yes
      PermitEmptyPasswords no
      X11Forwarding no
      MaxAuthTries 3
      ClientAliveInterval 300
      ClientAliveCountMax 2

  # Fail2ban config
  - path: /etc/fail2ban/jail.local
    permissions: "0644"
    content: |
      [DEFAULT]
      bantime = 1h
      findtime = 10m
      maxretry = 3

      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 24h

  # Auto security updates
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    permissions: "0644"
    content: |
      Unattended-Upgrade::Allowed-Origins {
        "Ubuntu:noble";
        "Ubuntu:noble-security";
        "UbuntuESMApps:noble-apps-security";
        "UbuntuESM:noble-infra-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";

  # Nginx reverse proxy config
  - path: /etc/nginx/sites-available/api
    permissions: "0644"
    content: |
      server {
          listen 80;
          server_name ${domain};

          location / {
              proxy_pass http://127.0.0.1:8080;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
      }

  # Kernel hardening
  - path: /etc/sysctl.d/99-security.conf
    permissions: "0644"
    content: |
      # IP Spoofing protection
      net.ipv4.conf.all.rp_filter = 1
      net.ipv4.conf.default.rp_filter = 1
      # Ignore ICMP redirects
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv6.conf.all.accept_redirects = 0
      # Disable source routing
      net.ipv4.conf.all.accept_source_route = 0
      net.ipv6.conf.all.accept_source_route = 0
      # Ignore send redirects
      net.ipv4.conf.all.send_redirects = 0
      # Block SYN attacks
      net.ipv4.tcp_syncookies = 1
      net.ipv4.tcp_max_syn_backlog = 2048
      net.ipv4.tcp_synack_retries = 2
      # Log Martians
      net.ipv4.conf.all.log_martians = 1
      # Ignore ICMP ping
      net.ipv4.icmp_echo_ignore_broadcasts = 1
      # Disable IPv6 if not needed
      net.ipv6.conf.all.disable_ipv6 = 1
      net.ipv6.conf.default.disable_ipv6 = 1

runcmd:
  # Security hardening
  - sysctl -p /etc/sysctl.d/99-security.conf
  - systemctl enable fail2ban
  - systemctl start fail2ban
  - systemctl restart sshd
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades

  # UFW firewall setup
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp comment 'SSH'
  - ufw allow 80/tcp comment 'HTTP'
  - ufw allow 443/tcp comment 'HTTPS'
  - ufw allow 8080/tcp comment 'Health check'
  - ufw --force enable

  # Docker setup
  - systemctl enable docker
  - systemctl start docker

  # Install docker compose v2
  - mkdir -p /root/.docker/cli-plugins
  - curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /root/.docker/cli-plugins/docker-compose
  - chmod +x /root/.docker/cli-plugins/docker-compose

  # Create monero user with no shell
  - useradd -r -m -d /opt/monero -s /usr/sbin/nologin monero

  # Download Monero CLI
  - cd /tmp && wget -q https://downloads.getmonero.org/cli/linux64
  - tar -xjf /tmp/linux64 -C /opt/monero --strip-components=1
  - chown -R monero:monero /opt/monero
  - chmod 700 /opt/monero

  # Create wallet directory with strict permissions
  - mkdir -p /opt/monero/wallets
  - chown monero:monero /opt/monero/wallets
  - chmod 700 /opt/monero/wallets

  # Docker Hub login
  - echo '${dockerhub_token}' | docker login -u '${dockerhub_username}' --password-stdin

  # Bot setup
  - mkdir -p /opt/telegram-bot/data /opt/telegram-bot/logs
  - chmod 777 /opt/telegram-bot/data /opt/telegram-bot/logs
  - chmod 700 /opt/telegram-bot
  - cd /opt/telegram-bot && curl -fsSL ${docker_compose_url} -o docker-compose.yml
  - docker pull polyxmedia/telegrambot:latest

  # Start services
  - systemctl daemon-reload
  - systemctl enable monero-wallet-rpc
  - systemctl start monero-wallet-rpc
  - systemctl enable telegram-bot
  - systemctl start telegram-bot

  # Nginx setup
  - ln -sf /etc/nginx/sites-available/api /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - systemctl enable nginx
  - systemctl start nginx

  # Cleanup
  - rm -f /tmp/linux64
  - apt-get clean
  - rm -rf /var/lib/apt/lists/*
