name: Deploy to Server

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Login to Docker Hub
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # Install docker compose v2 if needed
            if ! docker compose version &>/dev/null; then
              mkdir -p /root/.docker/cli-plugins
              curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /root/.docker/cli-plugins/docker-compose
              chmod +x /root/.docker/cli-plugins/docker-compose
            fi

            # Pull and restart
            cd /opt/telegram-bot
            docker compose pull
            docker compose up -d

            # Cleanup
            docker image prune -f

            # Verify
            sleep 5
            curl -f http://localhost:8080/health || exit 1
